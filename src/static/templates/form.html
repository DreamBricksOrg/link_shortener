<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novo Link Encurtado</title>
  <style>
    @import url('/src/static/css/global.css');
    @import url('/src/static/css/login.css');
    @import url('/src/static/css/form.css');
  </style>
</head>
<body>
  <div class="container">
    <div class="content">
      <div class="tittle">
        <h1>Novo Link</h1>
        <h2>Preencha os dados abaixo</h2>
      </div>

      <form id="shorten-form">
        <label>
          Titulo
          <input type="text" name="name" placeholder="Ex: Campanha Instagram" required />
        </label>
        <label>
          URL Original
          <input type="url" name="url" placeholder="https://..." required />
        </label>
        <label>
          Notas (opcional)
          <input type="text" name="notes" placeholder="Ex: UTM, canal, observações..." />
        </label>
        <label>
          Callback URL (opcional)
          <input type="url" name="callback_url" placeholder="https://..." />
        </label>
        <label>
          Slug Personalizado (opcional)
          <input type="text" name="slug" />
        </label>
        <label>
          Expira em (opcional)
          <input type="datetime-local" name="expires_at" />
        </label>
        
        <button type="submit">Gerar Link</button>
        <button type="button" id="admin-back" class="btn-secondary">Voltar</button>
      </form>

      <div class="spinner-container" id="spinner-container">
        <div class="spinner"></div>
      </div>

      <div id="result"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      Swal.fire({
        icon: 'warning',
        title: 'Acesso Negado',
        text: 'Faça login como admin primeiro.',
        confirmButtonText: 'Ir para Login'
      }).then(() => {
        location.href = '/auth/';
      });
    }
    
    document.getElementById("admin-back").addEventListener("click", () => { window.location.href = "/admin/";});
    
    document.getElementById("shorten-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const spinner = document.getElementById('spinner-container');
      const resultEl = document.getElementById("result");
      const submitBtn = e.target.querySelector('button[type="submit"]');
      
      spinner.style.display = 'block';
      resultEl.innerHTML = '';
      submitBtn.disabled = true;

      const form = e.target;
      const data = new FormData(form);

      try {
        const response = await fetch("/admin/shorten", {
          method: "POST",
          headers: { 'Authorization': 'Bearer ' + adminToken },
          body: data
        });

        if (response.status === 401) {
          Swal.fire({
            icon: 'error',
            title: 'Sessão Expirada',
            text: 'Por favor, faça login novamente.'
          }).then(() => location.href = "/auth/");
          return;
        }

        if (!response.ok) {
          const err = await response.json();
          Swal.fire({
            icon: 'error',
            title: 'Erro ao criar link',
            text: err.detail || 'Verifique os dados e tente novamente.'
          });
          return;
        }

        const result = await response.json();
        const link = `${window.location.origin}/${result.slug}`;
        
        resultEl.innerHTML = `
          <div class="result-box">
            <p>✅ Link criado com sucesso!</p>
            <p style="margin: 10px 0; font-size: 1.1rem;">
              <a href="${link}" target="_blank">${link}</a>
            </p>
            <div class="qrcodes">
              <div>
                <p>PNG</p>
                <a href="${result.qr_png}" download title="Baixar PNG">
                  <img src="${result.qr_png}" alt="QR PNG">
                </a>
              </div>
              <div>
                <p>SVG</p>
                <a href="${result.qr_svg}" download title="Baixar SVG">
                  <img src="${result.qr_svg}" alt="QR SVG">
                </a>
              </div>
            </div>
          </div>
        `;
        
        Swal.fire({
          icon: 'success',
          title: 'Sucesso!',
          text: 'Link encurtado criado.',
          timer: 1500,
          showConfirmButton: false
        });
        
        // Optional: clear form or keep it? Keeping it allows creating similar links easily.
        
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Erro de Conexão',
          text: 'Não foi possível contatar o servidor.'
        });
      } finally {
        spinner.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
