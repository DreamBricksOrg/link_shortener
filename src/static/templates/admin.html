<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin - Links Encurtados</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .controls, .filter-form, .entry { margin-bottom: 1.5rem; }
    .entry { border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
    label { margin-right: 1rem; }
    input[type="text"], select, input[type="date"] { margin-right: 0.5rem; }
    .status { margin-top: 0.5rem; color: green; }
  </style>
</head>
<body>
  <h1>Admin de Links Encurtados</h1>

  <div class="controls">
    <button id="reload-btn">Carregar</button>
    <button id="export-btn" hidden>Exportar CSV</button>
  </div>

  <div class="filter-form" hidden>
    <label>Slug: <input type="text" id="filter-slug"></label>
    <label>Descrição: <input type="text" id="filter-description"></label>
    <label>URL Original: <input type="text" id="filter-original"></label>
    <label>Callback URL: <input type="text" id="filter-callback"></label>
    <label>De: <input type="date" id="filter-date-from"></label>
    <label>Até: <input type="date" id="filter-date-to"></label>
    <button id="apply-filters-btn">Aplicar Filtros</button>
  </div>

  <div id="links-container"></div>

  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      alert('Faça login como admin primeiro.');
      location.href = '/login';
    }

    const filters = {
      'filter-slug': 'slug',
      'filter-description': 'description',
      'filter-original': 'original_url',
      'filter-callback': 'callback_url',
      'filter-date-from': 'date_from',
      'filter-date-to': 'date_to'
    };

    document.getElementById('reload-btn').addEventListener('click', () => loadLinks(true));
    document.getElementById('apply-filters-btn').addEventListener('click', () => loadLinks(false));
    document.getElementById('export-btn').addEventListener('click', () => exportCSV());

    async function loadLinks(showControls) {
      const params = new URLSearchParams();
      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) params.append(key, val);
      }

      const res = await fetch(`/admin/links?${params}`, {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (res.status === 401) {
        alert("Sessão expirada.");
        return location.href = "/login";
      }

      const json = await res.json();
      renderLinks(json.data || []);

      if (showControls) {
        document.querySelector('.filter-form').hidden = false;
        document.getElementById('export-btn').hidden = false;
        document.getElementById('reload-btn').textContent = "Recarregar";
      }
    }

    function renderLinks(list) {
      const c = document.getElementById("links-container");
      c.innerHTML = "";
      list.forEach(link => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.id = `link-${link.id}`;
        div.innerHTML = `
          <div><strong>${link.slug}</strong> – ${link.description}</div>
          <div>Original: <a href="${link.original_url}" target="_blank">${link.original_url}</a></div>
          <div>Status: ${link.status}</div>
          <div>Criado em: ${new Date(link.createdAt).toLocaleString()}</div>
          <div><code>${link.qr_png || ''}</code></div>
          <label>Descrição: <input type="text" id="desc-${link.id}" value="${link.description || ''}"></label>
          <label>URL Original: <input type="text" id="orig-${link.id}" value="${link.original_url || ''}"></label>
          <label>Callback: <input type="text" id="cb-${link.id}" value="${link.callback_url || ''}"></label>
          <div class="status" id="status-${link.id}"></div>
          <button onclick="updateLink('${link.id}')">Salvar</button>
          <button onclick="deleteLink('${link.id}')">Excluir</button>
        `;
        c.appendChild(div);
      });
    }

    async function updateLink(id) {
      const params = new URLSearchParams({
        description: document.getElementById(`desc-${id}`).value,
        original_url: document.getElementById(`orig-${id}`).value,
        callback_url: document.getElementById(`cb-${id}`).value,
      });

      const res = await fetch(`/admin/links/${id}?${params}`, {
        method: "PATCH",
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      const el = document.getElementById(`status-${id}`);
      if (res.ok) {
        el.textContent = "✔️ Atualizado!";
      } else {
        el.textContent = "❌ Erro ao atualizar.";
      }
    }

    async function deleteLink(id) {
      if (!confirm("Deseja realmente excluir este link?")) return;

      const res = await fetch(`/admin/links/${id}`, {
        method: "DELETE",
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (res.ok) {
        document.getElementById(`link-${id}`).remove();
      } else {
        alert("Erro ao excluir.");
      }
    }

    async function exportCSV() {
      const params = new URLSearchParams();
      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) params.append(key, val);
      }

      const res = await fetch(`/admin/links/export?${params}`, {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (!res.ok) return alert("Erro ao exportar.");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "links.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
