<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin - Links Encurtados</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .controls, .filter-form, .entry { margin-bottom: 1.5rem; }
    .entry { border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
    label { margin-right: 1rem; }
    input[type="text"], select, input[type="date"] { margin-right: 0.5rem; }
    .status { margin-top: 0.5rem; color: green; }
    a[id^="toggle-"]::before { content: "▶ "; display: inline-block; transition: transform 0.2s ease; }
    a.expanded::before { content: "▼ "; }
  </style>
</head>
<body>
  <h1>Admin de Links Encurtados</h1>

  <div class="controls">
    <button id="shortener-btn">Encurtador</button>
    <button id="reload-btn">Carregar</button>
    <button id="export-btn" hidden>Exportar CSV</button>
  </div>

  <div class="filter-form" hidden>
    <label>Slug: <input type="text" id="filter-slug"></label>
    <label>Descrição: <input type="text" id="filter-description"></label>
    <label>URL Original: <input type="text" id="filter-original"></label>
    <label>Callback URL: <input type="text" id="filter-callback"></label>
    <label>De: <input type="date" id="filter-date-from"></label>
    <label>Até: <input type="date" id="filter-date-to"></label>
    <button id="apply-filters-btn">Aplicar Filtros</button>
  </div>

  <div id="links-meta" style="margin: 0.5rem 0 1rem; color: #444;"></div>

  <div id="links-container"></div>

  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      alert('Faça login como admin primeiro.');
      location.href = '/auth/';
    }

    const filters = {
      'filter-slug': 'slug',
      'filter-description': 'description',
      'filter-original': 'original_url',
      'filter-callback': 'callback_url',
      'filter-date-from': 'date_from',
      'filter-date-to': 'date_to'
    };

    document.getElementById('reload-btn').addEventListener('click', () => {
      clearFilters();
      loadLinks(true);
    });
    document.getElementById('apply-filters-btn').addEventListener('click', () => loadLinks(false));
    document.getElementById('export-btn').addEventListener('click', () => exportCSV());
    document.getElementById("shortener-btn").addEventListener("click", () => { window.location.href = "/admin/form/";});

    async function loadLinks(showControls) {
      const params = new URLSearchParams();
      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) params.append(key, val);
      }

      const res = await fetch(`/admin/links?${params}`, {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (res.status === 401) {
        alert("Sessão expirada.");
        return location.href = "/auth/";
      }

      const json = await res.json();
      const total = json.total ?? (json.data ? json.data.length : 0);
      const shown = (json.data || []).length;
      renderMeta(total, shown);
      renderLinks(json.data || []);

      if (showControls) {
        document.querySelector('.filter-form').hidden = false;
        document.getElementById('export-btn').hidden = false;
        document.getElementById('reload-btn').textContent = "Recarregar";
      }
    }

    function clearFilters() {
      for (const id of Object.keys(filters)) {
        const el = document.getElementById(id);
        if (el) el.value = "";
      }
    }

    function renderMeta(total, shown) {
      const el = document.getElementById("links-meta");
      el.textContent = `Links: ${total} (mostrando ${shown})`;
    }

    function renderLinks(list) {
      const c = document.getElementById("links-container");
      c.innerHTML = "";
      list.forEach(link => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.id = `link-${link.id}`;
        div.innerHTML = `
          <div><strong>${link.slug}</strong> – ${link.description || ''}</div>
          <div>Original: <a href="${link.original_url}" target="_blank">${link.original_url}</a></div>
          <div>Status: ${link.status || ''}</div>
          <div>Criado em: ${link.created_at || ''}</div>

          <div id="qrbox-${link.id}">
            ${link.qr_png ? `<a href="${link.qr_png}" download target="_blank">
              <img src="${link.qr_png}" alt="QR code PNG" style="height: 120px">
            </a>` : ''}
            ${link.qr_svg ? `<a href="${link.qr_svg}" download target="_blank">
              <img src="${link.qr_svg}" alt="QR code SVG" style="height: 120px">
            </a>` : ''}
          </div>

          <div style="margin-top: 0.75rem;">
            <button onclick="regenerateQr('${link.slug}', '${link.id}')">Regenerar QR</button>
            <span class="status" id="qrstatus-${link.id}" style="margin-left: 0.5rem;"></span>
          </div>

          <div>
            <a href="javascript:void(0)" onclick="showAccessLog('${link.slug}')" id="toggle-${link.slug}">access_log</a>
            <pre id="log-${link.slug}" style="display:none; background:#eee; padding:1rem; overflow-x:auto;"></pre>
          </div>

          <label>Descrição: <input type="text" id="desc-${link.id}" value="${link.description || ''}"></label>
          <label>URL Original: <input type="text" id="orig-${link.id}" value="${link.original_url || ''}"></label>
          <label>Callback: <input type="text" id="cb-${link.id}" value="${link.callback_url || ''}"></label>

          <div class="status" id="status-${link.id}"></div>
          <button onclick="updateLink('${link.id}')">Salvar</button>
          <button onclick="deleteLink('${link.id}')">Excluir</button>
        `;
        c.appendChild(div);
      });
    }

    async function updateLink(id) {
      const params = new URLSearchParams({
        description: document.getElementById(`desc-${id}`).value,
        original_url: document.getElementById(`orig-${id}`).value,
        callback_url: document.getElementById(`cb-${id}`).value,
      });

      const res = await fetch(`/admin/links/${id}?${params}`, {
        method: "PATCH",
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      const el = document.getElementById(`status-${id}`);
      if (res.ok) {
        el.textContent = "✔️ Atualizado!";
      } else {
        el.textContent = "❌ Erro ao atualizar.";
      }
    }

    async function deleteLink(id) {
      if (!confirm("Deseja realmente excluir este link?")) return;

      const res = await fetch(`/admin/links/${id}`, {
        method: "DELETE",
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (res.ok) {
        document.getElementById(`link-${id}`).remove();
      } else {
        alert("Erro ao excluir.");
      }
    }

    async function exportCSV() {
      const params = new URLSearchParams();
      const activeFilters = [];

      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) {
          params.append(key, val);
          activeFilters.push(`${key}-${val}`);
        }
      }

      const res = await fetch(`/admin/links/export?${params}`, {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (!res.ok) {
        alert("Erro ao exportar.");
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const date = new Date().toISOString().slice(0, 10);
      const slugPart = activeFilters.length ? activeFilters.join("_") : "all";

      const a = document.createElement("a");
      a.download = `${slugPart}_logs_${date}.csv`;
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function showAccessLog(slug) {
      const pre = document.getElementById(`log-${slug}`);
      const toggle = document.getElementById(`toggle-${slug}`);
      const expanded = toggle.classList.toggle("expanded");

      if (!expanded) {
        pre.style.display = "none";
        pre.textContent = "";
        const btn = document.getElementById(`export-${slug}`);
        if (btn) btn.remove();
        return;
      }

      const res = await fetch(`/admin/links/${slug}/logs`, {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      });

      if (!res.ok) {
        pre.textContent = "Erro ao buscar logs.";
        pre.style.display = "block";
        return;
      }

      const logs = await res.json();
      const displayLogs = logs.slice(0, 3);
      let text = JSON.stringify(displayLogs, null, 2);
      if (logs.length > 3) text += `\n...`;

      pre.textContent = text;
      pre.style.display = "block";

      if (!document.getElementById(`export-${slug}`)) {
        const btn = document.createElement("button");
        btn.textContent = "Exportar CSV";
        btn.id = `export-${slug}`;
        btn.onclick = async () => {
          const res = await fetch(`/admin/links/${slug}/logs/export`, {
            headers: { 'Authorization': 'Bearer ' + adminToken }
          });

          if (!res.ok) {
            alert("Erro ao exportar.");
            return;
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const date = new Date().toISOString().slice(0, 10);
          a.download = `${slug}_logs_${date}.csv`;
          a.href = url;
          a.click();
          URL.revokeObjectURL(url);
        };
        pre.parentNode.insertBefore(btn, pre.nextSibling);
      }
    }

    async function regenerateQr(slug, id) {
      const statusEl = document.getElementById(`qrstatus-${id}`);
      statusEl.style.color = "green";
      statusEl.textContent = "Regenerando...";

      try {
        const res = await fetch(`/admin/qr/regenerate`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + adminToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ slug, force: true })
        });

        if (res.status === 401) {
          alert("Sessão expirada.");
          return location.href = "/auth/";
        }

        const json = await res.json();
        const result = (json.results || []).find(r => r.slug === slug);

        if (!res.ok || !result || !result.ok) {
          statusEl.style.color = "red";
          statusEl.textContent = "❌ Erro ao regenerar.";
          console.error("regenerate error:", json);
          return;
        }

        statusEl.style.color = "green";
        statusEl.textContent = "✔️ QR regenerado!";

        // Atualiza preview se veio URL
        const qrBox = document.getElementById(`qrbox-${id}`);
        const qrPng = result.qr_png;
        const qrSvg = result.qr_svg;

        // cache-bust simples pra forçar refresh no browser
        const bust = `t=${Date.now()}`;

        let html = "";
        if (qrPng) {
          const u = qrPng.includes("?") ? `${qrPng}&${bust}` : `${qrPng}?${bust}`;
          html += `<a href="${qrPng}" download target="_blank">
            <img src="${u}" alt="QR code PNG" style="height: 120px">
          </a>`;
        }
        if (qrSvg) {
          const u = qrSvg.includes("?") ? `${qrSvg}&${bust}` : `${qrSvg}?${bust}`;
          html += ` <a href="${qrSvg}" download target="_blank">
            <img src="${u}" alt="QR code SVG" style="height: 120px">
          </a>`;
        }

        qrBox.innerHTML = html;

      } catch (e) {
        statusEl.style.color = "red";
        statusEl.textContent = "❌ Erro (network).";
        console.error(e);
      }
    }

  </script>
</body>
</html>
