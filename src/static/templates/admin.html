<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Links Encurtados</title>
  <link rel="stylesheet" href="/src/static/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <h1>Admin de Links Encurtados</h1>

  <div class="controls">
    <button id="shortener-btn">Encurtador</button>
    <button id="reload-btn">Carregar</button>
    <button id="export-btn" hidden>Exportar CSV</button>
    <button id="links-btn">Links</button>
  </div>

  <div class="filter-form" hidden>
    <label>Slug: <input type="text" id="filter-slug"></label>
    <label>T√≠tulo: <input type="text" id="filter-tittle"></label>
    <label>Notas: <input type="text" id="filter-notes"></label>
    <label>URL Original: <input type="text" id="filter-original"></label>
    <label>Callback URL: <input type="text" id="filter-callback"></label>
    <label>De: <input type="date" id="filter-date-from"></label>
    <label>At√©: <input type="date" id="filter-date-to"></label>
    <button id="apply-filters-btn">Aplicar Filtros</button>
  </div>

  <div id="loading-spinner" class="spinner" style="display: none;"></div>
  <div id="links-container" class="links-grid"></div>

  <div class="pagination" id="pagination" hidden>
    <button id="prev-page-btn" disabled>Anterior</button>
    <span id="page-info">P√°gina 1</span>
    <button id="next-page-btn" disabled>Pr√≥xima</button>
  </div>

  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      Swal.fire({
        icon: 'warning',
        title: 'Acesso Negado',
        text: 'Fa√ßa login como admin primeiro.',
        confirmButtonText: 'Ir para Login'
      }).then(() => {
        location.href = '/auth/';
      });
    }

    const filters = {
      'filter-slug': 'slug',
      'filter-tittle': 'title',
      'filter-notes': 'notes',
      'filter-original': 'original_url',
      'filter-callback': 'callback_url',
      'filter-date-from': 'date_from',
      'filter-date-to': 'date_to'
    };

    let currentPage = 1;
    const pageSize = 9; // 3 rows of 3 columns

    document.getElementById('reload-btn').addEventListener('click', () => {
      currentPage = 1;
      loadLinks(true);
    });
    document.getElementById('apply-filters-btn').addEventListener('click', () => {
      currentPage = 1;
      loadLinks(false);
    });
    document.getElementById('links-btn').addEventListener('click', () => { window.location.href = "/admin/dash/links"; });
    document.getElementById('export-btn').addEventListener('click', () => exportCSV());
    document.getElementById("shortener-btn").addEventListener("click", () => { window.location.href = "/admin/form/";});
    
    document.getElementById('prev-page-btn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadLinks(false);
      }
    });

    document.getElementById('next-page-btn').addEventListener('click', () => {
      currentPage++;
      loadLinks(false);
    });

    async function loadLinks(showControls) {
      const spinner = document.getElementById('loading-spinner');
      const container = document.getElementById('links-container');
      const pagination = document.getElementById('pagination');
      
      spinner.style.display = 'block';
      container.innerHTML = '';
      pagination.hidden = true;

      const params = new URLSearchParams();
      params.append('page', currentPage);
      params.append('page_size', pageSize);
      
      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) params.append(key, val);
      }

      try {
        const res = await fetch(`/admin/links?${params}`, {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });

        if (res.status === 401) {
          Swal.fire({
            icon: 'error',
            title: 'Sess√£o Expirada',
            text: 'Por favor, fa√ßa login novamente.'
          }).then(() => location.href = "/auth/");
          return;
        }

        const json = await res.json();
        // Assume API returns { data: [...], total: ... } or just list. 
        // Adapting based on typical pagination. If just list, we handle it.
        const list = Array.isArray(json) ? json : (json.data || []);
        
        renderLinks(list);
        updatePagination(list.length);

        if (showControls) {
          document.querySelector('.filter-form').hidden = false;
          document.getElementById('export-btn').hidden = false;
          document.getElementById('reload-btn').textContent = "Recarregar";
        }
      } catch (error) {
        Swal.fire('Erro', 'Falha ao carregar links.', 'error');
        console.error(error);
      } finally {
        spinner.style.display = 'none';
        pagination.hidden = false;
      }
    }

    function updatePagination(itemsCount) {
      document.getElementById('page-info').textContent = `P√°gina ${currentPage}`;
      document.getElementById('prev-page-btn').disabled = currentPage === 1;
      // If we received fewer items than page size, it's the last page
      document.getElementById('next-page-btn').disabled = itemsCount < pageSize;
    }

    function renderLinks(list) {
      const c = document.getElementById("links-container");
      c.innerHTML = "";
      
      if (list.length === 0) {
        c.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Nenhum link encontrado.</p>';
        return;
      }

      list.forEach(link => {
        const div = document.createElement('div');
        div.className = 'card';
        div.id = `link-${link.id}`;
        div.innerHTML = `
          <div class="card-header">
            <span class="slug-title">${link.slug}</span>
            <span style="font-size: 0.8rem;">${new Date(link.created_at || Date.now()).toLocaleDateString()}</span>
          </div>
          
          <div class="card-body">
            <label>
              T√≠tulo
              <input type="text" id="title-${link.id}" value="${link.title || ''}">
            </label>
            <label>
              URL Original
              <input type="text" id="orig-${link.id}" value="${link.original_url || ''}">
            </label>
            <label>
              Notas
              <input type="text" id="notes-${link.id}" value="${link.notes || ''}">
            </label>
            <label>
              Callback URL
              <input type="text" id="cb-${link.id}" value="${link.callback_url || ''}">
            </label>
            
            <div class="qr-container" id="qr-container-${link.id}">
              ${link.qr_png ? `<a id="qr-png-a-${link.id}" href="${link.qr_png}" download target="_blank" title="Baixar PNG">
                <img id="qr-png-img-${link.id}" src="${link.qr_png}" alt="QR PNG">
              </a>` : ''}
              ${link.qr_svg ? `<a id="qr-svg-a-${link.id}" href="${link.qr_svg}" download target="_blank" title="Baixar SVG">
                <img id="qr-svg-img-${link.id}" src="${link.qr_svg}" alt="QR SVG">
              </a>` : ''}
            </div>
          </div>

          <div class="card-footer">
            <button onclick="showAccessLog('${link.slug}')">üìä Access Log</button>
            <button onclick="regenerateQr('${link.slug}', '${link.id}')">‚ôªÔ∏è Regenerar QR</button>
            <div class="card-actions">
              <button onclick="updateLink('${link.id}')">Salvar</button>
              <button class="btn-delete" onclick="deleteLink('${link.id}')">Excluir</button>
            </div>
            <div class="status" id="status-${link.id}" style="text-align: center; height: 1.2rem;"></div>
          </div>
        `;
        c.appendChild(div);
      });
    }

    async function updateLink(id) {
      const btn = document.querySelector(`#link-${id} button[onclick^="updateLink"]`);
      const originalText = btn.textContent;
      btn.textContent = 'Salvando...';
      btn.disabled = true;

      const params = new URLSearchParams({
        title: document.getElementById(`title-${id}`).value,
        original_url: document.getElementById(`orig-${id}`).value,
        notes: document.getElementById(`notes-${id}`).value,
        callback_url: document.getElementById(`cb-${id}`).value,
      });

      try {
        const res = await fetch(`/admin/links/${id}?${params}`, {
          method: "PATCH",
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });

        const el = document.getElementById(`status-${id}`);
        if (res.ok) {
          el.textContent = "‚úîÔ∏è Atualizado!";
          setTimeout(() => el.textContent = "", 2000);
        } else {
          el.textContent = "‚ùå Erro ao atualizar.";
          Swal.fire('Erro', 'N√£o foi poss√≠vel atualizar o link.', 'error');
        }
      } catch (err) {
        Swal.fire('Erro', 'Falha na comunica√ß√£o.', 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function deleteLink(id) {
      const result = await Swal.fire({
        title: 'Tem certeza?',
        text: "Esta a√ß√£o n√£o pode ser revertida!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          const res = await fetch(`/admin/links/${id}`, {
            method: "DELETE",
            headers: { 'Authorization': 'Bearer ' + adminToken }
          });

          if (res.ok) {
            document.getElementById(`link-${id}`).remove();
            Swal.fire('Exclu√≠do!', 'O link foi removido.', 'success');
          } else {
            Swal.fire('Erro', 'N√£o foi poss√≠vel excluir o link.', 'error');
          }
        } catch (err) {
          Swal.fire('Erro', 'Falha na comunica√ß√£o.', 'error');
        }
      }
    }

    async function exportCSV() {
      const params = new URLSearchParams();
      const activeFilters = [];

      for (const [id, key] of Object.entries(filters)) {
        const val = document.getElementById(id).value;
        if (val) {
          params.append(key, val);
          activeFilters.push(`${key}-${val}`);
        }
      }

      try {
        const res = await fetch(`/admin/links/export?${params}`, {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });

        if (!res.ok) throw new Error('Erro ao exportar');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().slice(0, 10);
        const slugPart = activeFilters.length ? activeFilters.join("_") : "all";

        const a = document.createElement("a");
        a.download = `${slugPart}_logs_${date}.csv`;
        a.href = url;
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar o CSV.', 'error');
      }
    }

    async function showAccessLog(slug) {
      Swal.fire({
        title: `Logs de acesso: ${slug}`,
        html: '<div class="spinner"></div><p>Carregando logs...</p>',
        showConfirmButton: false,
        width: '800px'
      });

      try {
        const res = await fetch(`/admin/links/${slug}/logs`, {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });

        if (res.status === 401) {
          Swal.fire({
            icon: 'error',
            title: 'Sess√£o Expirada',
            text: 'Por favor, fa√ßa login novamente.'
          }).then(() => location.href = "/auth/");
          return;
        }

        if (res.status === 204) {
          Swal.update({
            html: `
              <p>Nenhum registro de acesso encontrado para este link.</p>
              <div style="margin-top: 20px;">
                <button onclick="window.location.href='/admin/dash/link/${slug}'" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px;">Ver Dashboard Completo</button>
              </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'Fechar'
          });
          return;
        }

        if (!res.ok) throw new Error('Falha ao buscar logs');

        const logs = await res.json();
        
        let htmlContent = '';
        if (logs.length === 0) {
          htmlContent = '<p>Nenhum registro de acesso encontrado.</p>';
        } else {
          const rows = logs.slice(0, 50).map(log => `
            <tr>
              <td>${new Date(log.created_at || Date.now()).toLocaleString()}</td>
              <td>${log.ip || '-'}</td>
              <td>${log.browser || '-'}</td>
              <td>${log.os || '-'}</td>
              <td>${log.referer || '-'}</td>
            </tr>
          `).join('');

          htmlContent = `
            <div style="max-height: 400px; overflow-y: auto;">
              <table class="log-table">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>IP</th>
                    <th>Browser</th>
                    <th>OS</th>
                    <th>Referer</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
            ${logs.length > 50 ? '<p style="margin-top:10px; font-size:0.8rem; color:#666;">Mostrando √∫ltimos 50 registros.</p>' : ''}
            <div style="margin-top: 20px;">
              <button onclick="exportSingleLog('${slug}')" style="padding: 8px 16px;">Exportar CSV</button>
              <button onclick="window.location.href='/admin/dash/link/${slug}'" style="padding: 8px 16px; margin-left: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px;">Ver Dashboard Completo</button>
            </div>
          `;
        }

        Swal.update({
          html: htmlContent,
          showConfirmButton: true,
          confirmButtonText: 'Fechar'
        });

      } catch (err) {
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os logs.', 'error');
      }
    }

    async function exportSingleLog(slug) {
       try {
          const res = await fetch(`/admin/links/${slug}/logs/export`, {
            headers: { 'Authorization': 'Bearer ' + adminToken }
          });

          if (!res.ok) throw new Error('Erro ao exportar');

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const date = new Date().toISOString().slice(0, 10);
          a.download = `${slug}_logs_${date}.csv`;
          a.href = url;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os logs.', 'error');
        }
    }

    async function regenerateQr(slug, linkId) {
      const result = await Swal.fire({
        title: 'Regenerar QR Codes?',
        html: `
          <p>Slug: <strong>${slug}</strong></p>
          <label style="display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px;">
            <input id="swal-force" type="checkbox" checked />
            <span>For√ßar sobrescrever arquivos existentes</span>
          </label>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Regenerar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
          const force = document.getElementById('swal-force')?.checked ?? true;
          return { force };
        }
      });

      if (!result.isConfirmed) return;

      try {
        const res = await fetch(`/admin/qr/regenerate`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + adminToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ slug, force: result.value.force })
        });

        if (res.status === 401) {
          Swal.fire({
            icon: 'error',
            title: 'Sess√£o Expirada',
            text: 'Por favor, fa√ßa login novamente.'
          }).then(() => location.href = "/auth/");
          return;
        }

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          Swal.fire('Erro', err.detail || 'N√£o foi poss√≠vel regenerar os QR codes.', 'error');
          return;
        }

        const json = await res.json();
        const entry = (json.results || []).find(r => r.slug === slug);

        if (!entry || !entry.ok) {
          Swal.fire('Erro', 'N√£o foi poss√≠vel regenerar os QR codes para este link.', 'error');
          return;
        }

        const cacheBust = `v=${Date.now()}`;
        const pngUrl = entry.qr_png ? `${entry.qr_png}${entry.qr_png.includes('?') ? '&' : '?'}${cacheBust}` : null;
        const svgUrl = entry.qr_svg ? `${entry.qr_svg}${entry.qr_svg.includes('?') ? '&' : '?'}${cacheBust}` : null;

        const container = document.getElementById(`qr-container-${linkId}`);
        if (container) {
          if (pngUrl) {
            let a = document.getElementById(`qr-png-a-${linkId}`);
            let img = document.getElementById(`qr-png-img-${linkId}`);
            if (!a || !img) {
              a = document.createElement('a');
              a.id = `qr-png-a-${linkId}`;
              a.download = '';
              a.target = '_blank';
              a.title = 'Baixar PNG';
              img = document.createElement('img');
              img.id = `qr-png-img-${linkId}`;
              img.alt = 'QR PNG';
              a.appendChild(img);
              container.appendChild(a);
            }
            a.href = pngUrl;
            img.src = pngUrl;
          }

          if (svgUrl) {
            let a = document.getElementById(`qr-svg-a-${linkId}`);
            let img = document.getElementById(`qr-svg-img-${linkId}`);
            if (!a || !img) {
              a = document.createElement('a');
              a.id = `qr-svg-a-${linkId}`;
              a.download = '';
              a.target = '_blank';
              a.title = 'Baixar SVG';
              img = document.createElement('img');
              img.id = `qr-svg-img-${linkId}`;
              img.alt = 'QR SVG';
              a.appendChild(img);
              container.appendChild(a);
            }
            a.href = svgUrl;
            img.src = svgUrl;
          }
        }

        Swal.fire('Sucesso', `QR regenerado${entry.reason ? ` (${entry.reason})` : ''}.`, 'success');

      } catch (e) {
        Swal.fire('Erro', 'Falha na comunica√ß√£o.', 'error');
      }
    }

    loadLinks(true);
  </script>
</body>
</html>
