<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes do Link - Dashboard</title>
  <link rel="stylesheet" href="/src/static/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .header-info {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .header-info h2,
    .header-info p,
    .header-info a {
        overflow-wrap: anywhere;
        word-break: break-word;
    }
    .header-info a {
        display: inline;
    }
    .grid-charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .chart-box {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        min-height: 300px;
    }
    .chart-canvas-wrap {
        position: relative;
        height: 320px;
    }
    .chart-canvas-wrap.is-line {
        height: 400px;
    }
    .chart-box canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }
    .full-width {
        grid-column: span 2;
    }
    .nav-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .nav-link {
        text-decoration: none;
        color: #666;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 4px;
    }
    .nav-link:hover { background-color: #f5f5f5; }
    
    /* Tabs */
    .tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #eee;
    }
    .tab-btn {
        padding: 10px 20px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: #666;
    }
    .tab-btn.active {
        border-bottom-color: #034a5d;
        color: #034a5d;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* Logs Table */
    .log-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .log-table th, .log-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .log-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .pagination {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        align-items: center;
    }

    @media(max-width: 768px) {
        .grid-charts { grid-template-columns: 1fr; }
        .full-width { grid-column: span 1; }
        .chart-box { min-height: 240px; }
        .chart-canvas-wrap { height: 260px; }
        .chart-canvas-wrap.is-line { height: 320px; }
        .top-controls { flex-direction: column; align-items: stretch; gap: 12px; }
        .top-controls .tabs { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
        #range-select { width: 100%; }
        .header-info { padding: 1rem; margin-bottom: 1.25rem; }
        .header-info h2 { font-size: 1.25rem; }
        .header-info p { margin: 0.5rem 0; }
    }
  </style>
</head>
<body>
  <h1>Detalhes do Link</h1>

  <div class="nav-bar">
      <a href="/admin/dashboard" class="nav-link">Visão Geral</a>
      <a href="/admin/dash/links" class="nav-link">Links</a>
      <a href="/admin/dash/logs" class="nav-link">Logs de Acesso</a>
      <a href="/admin/" class="nav-link" style="margin-left: auto;">Voltar ao Admin</a>
  </div>

  <div class="header-info" id="link-info">
      Loading info...
  </div>

  <div class="top-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <div class="tabs" style="margin-bottom: 0; border-bottom: none;">
          <button class="tab-btn active" onclick="switchTab('overview')">Visão Geral</button>
          <button class="tab-btn" onclick="switchTab('logs')">Logs de Acesso</button>
      </div>

      <select id="range-select" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
          <option value="7">Últimos 7 dias</option>
          <option value="30">Últimos 30 dias</option>
          <option value="90">Últimos 90 dias</option>
      </select>
  </div>

  <hr style="margin-bottom: 2rem; border: 0; border-top: 1px solid #eee;">

  <!-- TAB: OVERVIEW -->
  <div id="tab-overview" class="tab-content active">
      <div class="grid-charts">
          <div class="chart-box full-width">
              <h3>Evolução de Cliques</h3>
              <div class="chart-canvas-wrap is-line">
                  <canvas id="lineChart"></canvas>
              </div>
          </div>
          <div class="chart-box">
              <h3>Navegadores</h3>
              <div class="chart-canvas-wrap">
                  <canvas id="browserChart"></canvas>
              </div>
          </div>
          <div class="chart-box">
              <h3>Sistemas Operacionais</h3>
              <div class="chart-canvas-wrap">
                  <canvas id="osChart"></canvas>
              </div>
          </div>
          <div class="chart-box">
              <h3>Dispositivos</h3>
              <div class="chart-canvas-wrap">
                  <canvas id="deviceChart"></canvas>
              </div>
          </div>
          <div class="chart-box">
              <h3>Geolocalização (Top 5)</h3>
              <ul id="geo-list" style="list-style: none; padding: 0;"></ul>
          </div>
      </div>
  </div>

  <!-- TAB: LOGS -->
  <div id="tab-logs" class="tab-content">
      <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
          <div id="logs-loading" class="spinner" style="display:none;"></div>
          <table class="log-table">
              <thead>
                  <tr>
                      <th>Data/Hora</th>
                      <th>IP</th>
                      <th>Browser</th>
                      <th>OS</th>
                      <th>Referer</th>
                  </tr>
              </thead>
              <tbody id="logs-tbody">
                  <!-- Rows injected here -->
              </tbody>
          </table>
          
          <div class="pagination" id="logs-pagination">
              <button id="btn-prev" disabled>Anterior</button>
              <span id="page-info">Página 1</span>
              <button id="btn-next" disabled>Próxima</button>
          </div>
      </div>
  </div>

  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) location.href = '/auth/';

    const pathParts = window.location.pathname.split('/');
    const slug = pathParts[pathParts.length - 1];

    let charts = {};
    let currentTab = 'overview';
    let logsPage = 1;
    const logsPageSize = 50;

    // Initial Load
    loadData();

    document.getElementById('range-select').addEventListener('change', () => {
        loadData();
    });

    document.getElementById('btn-prev').addEventListener('click', () => {
        if (logsPage > 1) {
            logsPage--;
            loadLogs();
        }
    });

    document.getElementById('btn-next').addEventListener('click', () => {
        logsPage++;
        loadLogs();
    });

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');

        if (tab === 'logs') {
            logsPage = 1; // Reset to page 1 on tab switch? Or keep state? Let's reset for simplicity.
            loadLogs();
        } else {
            loadStats();
        }
    }

    function getDateRange() {
        const days = document.getElementById('range-select').value;
        const toDate = new Date();
        const fromDate = new Date();
        fromDate.setDate(toDate.getDate() - days);
        return {
            from: fromDate.toISOString().split('T')[0],
            to: toDate.toISOString().split('T')[0]
        };
    }

    function loadData() {
        if (currentTab === 'overview') loadStats();
        else loadLogs();
    }

    async function loadStats() {
        const { from, to } = getDateRange();
        try {
            const res = await fetch(`/dash/links/${slug}/stats?from=${from}&to=${to}`, {
                headers: { 'Authorization': 'Bearer ' + adminToken }
            });
            if (res.status === 401) { location.href = '/auth/'; return; }
            
            const data = await res.json();
            renderInfo(data);
            renderCharts(data);
        } catch(e) {
            console.error(e);
            Swal.fire('Erro', 'Falha ao carregar estatísticas', 'error');
        }
    }

    async function loadLogs() {
        const { from, to } = getDateRange();
        const tbody = document.getElementById('logs-tbody');
        const spinner = document.getElementById('logs-loading');
        
        spinner.style.display = 'block';
        tbody.innerHTML = '';
        
        try {
            const res = await fetch(`/dash/access-logs?slug=${slug}&from=${from}&to=${to}&page=${logsPage}&page_size=${logsPageSize}`, {
                headers: { 'Authorization': 'Bearer ' + adminToken }
            });
            
            const json = await res.json();
            const logs = json.data || [];
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Nenhum registro no período.</td></tr>';
            } else {
                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>${log.ip || '-'}</td>
                        <td>${log.browser || '-'}</td>
                        <td>${log.os || '-'}</td>
                        <td>${log.referer || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Pagination Logic
            document.getElementById('page-info').textContent = `Página ${logsPage}`;
            document.getElementById('btn-prev').disabled = logsPage === 1;
            // Crude check: if we got fewer items than page size, it's the last page
            document.getElementById('btn-next').disabled = logs.length < logsPageSize;

        } catch(e) {
            console.error(e);
            Swal.fire('Erro', 'Falha ao carregar logs', 'error');
        } finally {
            spinner.style.display = 'none';
        }
    }

    function renderInfo(data) {
        const link = data.link;
        if (!link) return;
        
        document.getElementById('link-info').innerHTML = `
            <h2 style="margin-top:0; color:#034a5d;">${link.slug}</h2>
            <p><strong>URL Original:</strong> <a href="${link.original_url}" target="_blank">${link.original_url}</a></p>
            <p><strong>Título:</strong> ${link.title || '-'}</p>
            <p><strong>Total Cliques (Período):</strong> ${data.clicks_total}</p>
            <p><strong>IPs Únicos:</strong> ${data.unique_ips}</p>
        `;
    }

    function renderCharts(data) {
        // Line Chart
        destroyChart('line');
        const ctxLine = document.getElementById('lineChart').getContext('2d');
        charts['line'] = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: data.series.map(s => s.bucket),
                datasets: [{
                    label: 'Cliques',
                    data: data.series.map(s => s.clicks),
                    borderColor: '#42b0d5',
                    backgroundColor: 'rgba(66, 176, 213, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Evolução de Cliques no Período',
                        color: '#034a5d',
                        font: { size: 16 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // Browser Chart (Pie/Doughnut)
        destroyChart('browser');
        const ctxBrowser = document.getElementById('browserChart').getContext('2d');
        charts['browser'] = new Chart(ctxBrowser, {
            type: 'pie',
            data: {
                labels: data.browsers.map(b => b.key || 'Desconhecido'),
                datasets: [{
                    data: data.browsers.map(b => b.count),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // OS Chart (Pie)
        destroyChart('os');
        const ctxOS = document.getElementById('osChart').getContext('2d');
        charts['os'] = new Chart(ctxOS, {
            type: 'pie',
            data: {
                labels: data.os.map(o => o.key || 'Desconhecido'),
                datasets: [{
                    data: data.os.map(o => o.count),
                    backgroundColor: ['#FF9F40', '#FFCD56', '#4BC0C0', '#36A2EB', '#9966FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Device Chart (Pie - user requested Pie for "outros campos")
        // User said: "graficos de pizza nos outros campos 'Navegadores', 'Sistemas Operacionais', 'Dispositivos'"
        destroyChart('device');
        const ctxDevice = document.getElementById('deviceChart').getContext('2d');
        charts['device'] = new Chart(ctxDevice, {
            type: 'pie', // Changed from bar to pie as requested
            data: {
                labels: data.device_type.map(d => d.key),
                datasets: [{
                    label: 'Dispositivos',
                    data: data.device_type.map(d => d.count),
                    backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Geo List
        const geoList = document.getElementById('geo-list');
        geoList.innerHTML = '';
        if (data.geo.length === 0) {
            geoList.innerHTML = '<li>Sem dados de localização</li>';
        }
        data.geo.forEach(g => {
            const li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid #eee';
            li.innerHTML = `<strong>${g.country || '-'}</strong> / ${g.region || '-'} - ${g.count} cliques`;
            geoList.appendChild(li);
        });
    }

    function destroyChart(key) {
        if (charts[key]) {
            charts[key].destroy();
            charts[key] = null;
        }
    }
  </script>
</body>
</html>
